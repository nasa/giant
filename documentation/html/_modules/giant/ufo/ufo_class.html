<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>giant.ufo.ufo_class &#8212; GIANT 2.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=3f530b75" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=aae3c237" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
    <script src="../../../_static/documentation_options.js?v=51b770b3"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../../../_static/logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="copyright" title="Copyright" href="../../../copyright.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/logo.png" alt="Logo" />
    
  </a>
</p>



<p class="blurb">A powerful API for Optical Navigation</p>






<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installing GIANT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../giant.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../giant.html#indices">Indices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../copyright.html">Copyright</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
  <h1>Source code for giant.ufo.ufo_class</h1><div class="highlight"><pre>
<span></span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module provides a user interface class for detecting and tracking unidentified objects in monocular images.</span>

<span class="sd">Description</span>
<span class="sd">-----------</span>

<span class="sd">The process of identifying and tracking unidentified objects in monocular images is complex.  It involves extracting</span>
<span class="sd">possible detections from images based only on the images themselves and then attempting to link those detections from</span>
<span class="sd">image to image to create tracks.  The end results is an autonomous system that is capable of capturing many observed</span>
<span class="sd">particles with limited to no human interaction.  For more details refer to the :mod:`.detector` and :mod:`.ekf_tracker`</span>
<span class="sd">packages or to the paper at</span>
<span class="sd">https://agupubs.onlinelibrary.wiley.com/doi/pdf/10.1029/2019EA000843</span>

<span class="sd">Use</span>
<span class="sd">---</span>

<span class="sd">The :class:`.UFO` class is the main interface for autonomous detection and tracking of objects in images in GIANT.  It</span>
<span class="sd">provides everything that a user will need to interact with for extracting detections and tracks, reviewing them</span>
<span class="sd">visually, and saving the results to the disk.  This includes access to the :class:`.Detector` and :class:`.Tracker`</span>
<span class="sd">classes and their attributes.  In addition methods are provides which package everything together and feed the results</span>
<span class="sd">of the :class:`.Detector` into the :class:`.Tracker` for you so you don&#39;t need to worry about how to transfer the data</span>
<span class="sd">around.  Finally, this also provides direct access to the :mod:`.ufo.visualizers` module along with its</span>
<span class="sd">classes/functions, making it easy to visually inspect and modify the results.</span>

<span class="sd">The typical workflow will be initialize the :class:`.UFO` class, call :meth:`.UFO.detect`, call :meth:`.UFO.track`, call</span>
<span class="sd">:meth:`.UFO.save_results`.</span>

<span class="sd">For a description of the tuning parameters that can be messed with refer to the :class:`.Detector`/:class:`.Tracker`</span>
<span class="sd">documentation or the :mod:`.ufo` documentation.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial</span><span class="w"> </span><span class="kn">import</span> <span class="n">KDTree</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">giant.camera</span><span class="w"> </span><span class="kn">import</span> <span class="n">Camera</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">giant.ray_tracer.scene</span><span class="w"> </span><span class="kn">import</span> <span class="n">Scene</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">giant.stellar_opnav.stellar_class</span><span class="w"> </span><span class="kn">import</span> <span class="n">StellarOpNav</span><span class="p">,</span> <span class="n">StellarOpNavOptions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">giant.ufo.detector</span><span class="w"> </span><span class="kn">import</span> <span class="n">Detector</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">giant.ufo.ekf_tracker</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tracker</span><span class="p">,</span> <span class="n">Dynamics</span><span class="p">,</span> <span class="n">STATE_INITIALIZER_TYPE</span><span class="p">,</span> <span class="n">ExtendedKalmanFilter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">giant.point_spread_functions.gaussians</span><span class="w"> </span><span class="kn">import</span> <span class="n">IterativeGeneralizedGaussianWBackground</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">giant._typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">PATH</span>


<span class="n">_LOGGER</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This is the logging interface for reporting status, results, issues, and other information.</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="UFO">
<a class="viewcode-back" href="../../../ufo/ufo_class/giant.ufo.ufo_class.UFO.html#giant.ufo.ufo_class.UFO">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">UFO</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class provides a simple user interface for doing the combined steps of detecting and tracking UFOs in images.</span>

<span class="sd">    The primary benefit to using this class is that it packages the data from the :class:`.Detector` class to the</span>
<span class="sd">    :class:`.Tracker` class without you having to interact with it directly.  Beyond that it is primarily just calls to</span>
<span class="sd">    the methods of the :class:`.Detector` and :class:`.Tracker` classes, letting them do all of the hard work behind the</span>
<span class="sd">    scenes.</span>

<span class="sd">    The typical way to use this class it to initialize it with all of the settings needed for the :class:`.Detector` and</span>
<span class="sd">    :class:`.Tracker` and then to call the following methods in order:</span>

<span class="sd">    #. :meth:`detect`</span>
<span class="sd">    #. :meth:`track`</span>
<span class="sd">    #. :meth:`save_results`</span>
<span class="sd">    #. :meth:`visualize_detection_results`</span>

<span class="sd">    If your settings were right, this should result in 2 csv files (1 with possible detections and one with possible</span>
<span class="sd">    tracks) and a visualization of the detections for each image displayed either interactively or saved to files.</span>

<span class="sd">    For more details about the processes working in this class or for successfully tuning things for identifying tracks,</span>
<span class="sd">    see the :mod:.detector`, :mod:`.tracker`, and :mod:`.ufo` documentation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">camera</span><span class="p">:</span> <span class="n">Camera</span><span class="p">,</span> <span class="n">scene</span><span class="p">:</span> <span class="n">Scene</span><span class="p">,</span> <span class="n">dynamics</span><span class="p">:</span> <span class="n">Dynamics</span><span class="p">,</span> <span class="n">state_initializer</span><span class="p">:</span> <span class="n">STATE_INITIALIZER_TYPE</span><span class="p">,</span>
                 <span class="n">search_distance_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ExtendedKalmanFilter</span><span class="p">],</span> <span class="nb">float</span><span class="p">],</span>
                 <span class="n">detector_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">tracker_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">initial_sopnav_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StellarOpNavOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">tracking_quality_code_minimum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                 <span class="n">identify_hot_pixels_and_unmatched_stars</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">clear_detector_before_tracking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">visual_inspection_quality_code_minimum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param camera: The :class:`.Camera` containing the images to be processed</span>
<span class="sd">        :param scene: The :class:`.Scene` specifying the central body as the first target and any extra extended</span>
<span class="sd">                      bodies that should be ignored as other targets.</span>
<span class="sd">        :param dynamics: The dynamics model to use in the EKF for propagating the state from one time to another</span>
<span class="sd">        :param state_initializer: A callable which takes in a :class:`.Measurement` instance and</span>
<span class="sd">                                  :class:`.Dynamics.State` class object and returns an initialized state.</span>
<span class="sd">        :param search_distance_function: A callable which takes in an :class:`.ExtendedKalmanFilter` and returns what</span>
<span class="sd">                                         the Euclidean search distance should be for that EKF in pixels.  This is only</span>
<span class="sd">                                         applied after the first pair has been made</span>
<span class="sd">        :param detector_kwargs: The key word arguments to pass to the :class:`.Detector` class</span>
<span class="sd">        :param tracker_kwargs: The key word arguments to pass to the :class:`.Tracker` class</span>
<span class="sd">        :param initial_sopnav_options: The options struct to use to initialize the :class:`.StellarOpNav` instance</span>
<span class="sd">                                                instance before it is passed to the :class:`.Detector`</span>
<span class="sd">        :param tracking_quality_code_minimum: The minimum quality code to pass a possible detection to the tracking</span>
<span class="sd">                                              algorithm</span>
<span class="sd">        :param identify_hot_pixels_and_unmatched_stars: A flag specifying whether to attempt to filter out hot pixels</span>
<span class="sd">                                                        and unmatched stars from the UFO detections</span>
<span class="sd">        :param clear_detector_before_tracking: A flag specifying whether to clear out the intermediate lists created in</span>
<span class="sd">                                               the :class:`.Detector` before moving on to the :class:`.Tracker`.  This</span>
<span class="sd">                                               can be necessary for memory management purposes</span>
<span class="sd">        :param visual_inspection_quality_code_minimum: The minimum quality code to pass a possible detection to the</span>
<span class="sd">                                                       detection visualizations</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sopnav</span> <span class="o">=</span> <span class="n">StellarOpNav</span><span class="p">(</span><span class="n">camera</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">initial_sopnav_options</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">detector_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">detector_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="n">Detector</span><span class="p">(</span><span class="n">sopnav</span><span class="p">,</span> <span class="n">scene</span><span class="o">=</span><span class="n">scene</span><span class="p">,</span> <span class="o">**</span><span class="n">detector_kwargs</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The :class:`.Detector` instance to use to identify possible UFOs in the images</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">tracker_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tracker_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracker</span><span class="p">:</span> <span class="n">Tracker</span> <span class="o">=</span> <span class="n">Tracker</span><span class="p">(</span><span class="n">camera</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">dynamics</span><span class="p">,</span> <span class="n">state_initializer</span><span class="p">,</span> <span class="n">search_distance_function</span><span class="p">,</span>
                                        <span class="o">**</span><span class="n">tracker_kwargs</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The :class:`.Tracker` instance to use to track UFOs from one frame to the next</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tracking_quality_code_minimum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">tracking_quality_code_minimum</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This specifies the minimum quality code for a detection to be passed to the tracker.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">identify_hot_pixels_and_unmatched_stars</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">identify_hot_pixels_and_unmatched_stars</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This boolean indicates that we should attempt to identify hot pixels and stars from the ufo detections from the</span>
<span class="sd">        current set of images.</span>
<span class="sd">        </span>
<span class="sd">        If this is ``True`` the :meth:`.Detector.identify_hot_pixels_and_unmatched_stars` is called as part of</span>
<span class="sd">        :meth:`detect`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">visual_inspection_quality_code_minimum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">visual_inspection_quality_code_minimum</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This specifies the minimum quality code for a detection to be shown in the visualization.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clear_detector_before_tracking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">clear_detector_before_tracking</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This clears data from the detector/sopnav classes (besides what is in the :attr:`.detection_data_frame`) before </span>
<span class="sd">        attempting to track UFOs from image to image.  </span>
<span class="sd">        </span>
<span class="sd">        This can be important for memory management issues, especially if your machine doesn&#39;t have a lot of memory. As </span>
<span class="sd">        such it is recommended to always leave this ``True``.  Note that if this is ``True`` however, and you call</span>
<span class="sd">        :meth:`track` then you will no longer be able to retrieve data about the detection from the attributes in the </span>
<span class="sd">        :class:`.Detector` class.  Instead you must access all data from the :attr:`.Detector.detection_data_frame` </span>
<span class="sd">        attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="UFO.detect">
<a class="viewcode-back" href="../../../ufo/ufo_class/giant.ufo.ufo_class.UFO.detect.html#giant.ufo.ufo_class.UFO.detect">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">detect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method detects potential UFOs in all images that have been added to the camera and have not been processed</span>
<span class="sd">        yet.</span>

<span class="sd">        This essentially boils down to a series of calls to :class:`.Detector` methods.</span>

<span class="sd">        #. :meth:`.Detector.update_attitude`</span>
<span class="sd">        #. :meth:`.Detector.find_ufos`</span>
<span class="sd">        #. :meth:`.Detector.package_results`</span>
<span class="sd">        #. :meth:`.Detector.remove_duplicate`</span>
<span class="sd">        #. Optionally :meth:`.Detector.identify_hot_pixels_and_unmatched_stars`</span>

<span class="sd">        where the last is only called if :attr:`identify_hot_pixels_and_unmatched_stars` is set to ``True``</span>

<span class="sd">        Once complete, the results of the detections can be found in :attr:`.Detector.detection_data_frame`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">update_attitude</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">find_ufos</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">package_results</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">remove_duplicates</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_hot_pixels_and_unmatched_stars</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">identify_hot_pixels_and_unmatched_stars</span><span class="p">()</span></div>


<div class="viewcode-block" id="UFO.track">
<a class="viewcode-back" href="../../../ufo/ufo_class/giant.ufo.ufo_class.UFO.track.html#giant.ufo.ufo_class.UFO.track">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">track</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method packages the possible UFO detections for the :class:`.Tracker`, passes them to the tracker, and then</span>
<span class="sd">        attempts to track the UFOs from image to image.</span>

<span class="sd">        The packaging of the detections essentially boils down to building a scipy.spatial ``cKDTree`` on the</span>
<span class="sd">        ``(x_raw, y_raw)`` pixel locations for each detection, and retrieving the id for each UFO detection (the index</span>
<span class="sd">        of the :attr:`.Detector.detection_data_frame`).  This data is then passed to the :attr:`tracker`, and the</span>
<span class="sd">        :meth:`.Tracker.track` method is called.  The results are then stored in the :attr:`.Tracker.confirmed_filters`</span>
<span class="sd">        and :attr:`.Tracker.confirmed_standard_deviations` attributes.</span>

<span class="sd">        You can filter which possible detections are fed to the tracker using the :attr:`tracking_quality_code_minimum`</span>
<span class="sd">        attribute.</span>

<span class="sd">        Note that this method can take a while to run, will use multi-processing, and will likely take up a lot of</span>
<span class="sd">        memory (depending on the number of images/number of detections per image).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># clear out the information from the detector before continuing to save memory</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_detector_before_tracking</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Clearing out unnecessary detector lists&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">clear_results</span><span class="p">()</span>

        <span class="c1"># get the dataframe of detections</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">detection_data_frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must call detect before track&#39;</span><span class="p">)</span>
        <span class="n">ufos</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">detection_data_frame</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Filtering </span><span class="si">{</span><span class="n">ufos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> detections by quality code &gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tracking_quality_code_minimum</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># filter based on the quality code</span>
        <span class="n">ufos</span> <span class="o">=</span> <span class="n">ufos</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ufos</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;quality_code&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracking_quality_code_minimum</span><span class="p">]</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ufos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> detections retained&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">ufos</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;image_file&#39;</span><span class="p">):</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">grp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">image</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># build the kdtree and retrieve the identities for each detection</span>
        <span class="n">kd_trees</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Building detection KDTrees&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">image_file</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">ufos</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;image_file&quot;</span><span class="p">):</span>

            <span class="n">kd_trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">KDTree</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;x_raw&#39;</span><span class="p">,</span> <span class="s1">&#39;y_raw&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()))</span>
            <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ufos</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

        <span class="c1"># feed this data to the tracker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracker</span><span class="o">.</span><span class="n">observation_trees</span> <span class="o">=</span> <span class="n">kd_trees</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracker</span><span class="o">.</span><span class="n">observation_ids</span> <span class="o">=</span> <span class="n">ids</span>

        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Tracking&#39;</span><span class="p">)</span>
        <span class="c1"># let it do its thing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracker</span><span class="o">.</span><span class="n">track</span><span class="p">()</span></div>


<div class="viewcode-block" id="UFO.save_results">
<a class="viewcode-back" href="../../../ufo/ufo_class/giant.ufo.ufo_class.UFO.save_results.html#giant.ufo.ufo_class.UFO.save_results">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detection_results</span><span class="p">:</span> <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;./detections.csv&quot;</span><span class="p">,</span> <span class="n">tracking_results</span><span class="p">:</span> <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;./tracks.csv&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method saves both the detection and tracker results to a file (as long as they have been run).</span>

<span class="sd">        The detection results are saved to the ``detection_results`` path specified by the user.  The tracking results</span>
<span class="sd">        are saved to the ``tracking_results`` path specified by the user.  If the detector or the tracker have not been</span>
<span class="sd">        run a warning is printed and nothing happens.</span>

<span class="sd">        :param detection_results: The file to save the detections csv file to</span>
<span class="sd">        :param tracking_results:  The file to save the tracking csv file to</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">detection_data_frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The detector has not been run yet&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving detection results to </span><span class="si">{</span><span class="n">detection_results</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">save_results</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">detection_results</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracker</span><span class="o">.</span><span class="n">confirmed_filters</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The tracker has not been run yet&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving tracking results to </span><span class="si">{</span><span class="n">tracking_results</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tracker</span><span class="o">.</span><span class="n">save_results</span><span class="p">(</span><span class="n">tracking_results</span><span class="p">)</span></div>


<div class="viewcode-block" id="UFO.visualize_detection_results">
<a class="viewcode-back" href="../../../ufo/ufo_class/giant.ufo.ufo_class.UFO.visualize_detection_results.html#giant.ufo.ufo_class.UFO.visualize_detection_results">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_detection_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interactive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">save_frames</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="n">frame_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;./</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method visualizes detection results, overlaying them on the images themselves.</span>

<span class="sd">        The detections are filtered based off of quality code using :attr:`visual_inspection_quality_code_minimum`.</span>

<span class="sd">        They are then plotted on the images.  The plots can either be saved to file (if ``save_frames`` is set to</span>
<span class="sd">        ``True``), displayed interactively (if ``interactive`` is set to ``True``) or displayed all at once (if</span>
<span class="sd">        ``save_frames`` and ``frame_output`` are both set to ``False``).  Note that this last option can make a lot of</span>
<span class="sd">        figures, therefore we encourage you to use the ``interactive`` option instead.</span>

<span class="sd">        For more details refer to the :func:`.show_detections` function.</span>

<span class="sd">        :param interactive: Generate an interactive GUI for flipping through the frames</span>
<span class="sd">        :param save_frames: Save all frames to a file and don&#39;t display them on the screen</span>
<span class="sd">        :param frame_output: The location to save all of the frames.  Should include a format specifier {} which will be</span>
<span class="sd">                             replaced with the name of the image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">giant.ufo.visualizer</span><span class="w"> </span><span class="kn">import</span> <span class="n">show_detections</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">detection_data_frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must call detect before visualize_detection_results&#39;</span><span class="p">)</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Filtering </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">detection_data_frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> detections by quality code &gt; &#39;</span>
                     <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">visual_inspection_quality_code_minimum</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">quality_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">detection_data_frame</span><span class="o">.</span><span class="n">quality_code</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual_inspection_quality_code_minimum</span>
        <span class="n">ufos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">detection_data_frame</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">quality_test</span><span class="p">]</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ufos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> detections will be displayed&#39;</span><span class="p">)</span>

        <span class="n">show_detections</span><span class="p">(</span><span class="n">ufos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">sopnav</span><span class="o">.</span><span class="n">camera</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="n">interactive</span><span class="p">,</span> <span class="n">save_frames</span><span class="o">=</span><span class="n">save_frames</span><span class="p">,</span>
                        <span class="n">frame_output</span><span class="o">=</span><span class="n">frame_output</span><span class="p">)</span></div>
</div>

</pre></div>

          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
<div class="footer">
    <div style="display:inline-block;vertical-align:middle;">
        <img src="/_static/NASA_logo.svg" alt="NASA" style="width:80px;height:80px;">
    </div>
    <div style="display:inline-block;vertical-align:middle;">
        &copy;2023 United States Government | 
        NASA Official: <a href="mailto:andrew.j.liounis@nasa.gov">Andrew Liounis</a> |
        Curator: <a href="mailto:andrew.j.liounis@nasa.gov">Andrew Liounis</a>
        <br>
        Last updated on Sep 03, 2025 |
        
        |
        Powered by <a href="http://sphinx-doc.org/">Sphinx 8.2.3</a>
        &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 1.0.0</a>
        
        |
        <a href="https://www.nasa.gov/about/highlights/HP_Privacy.html">Privacy Policy/Notices</a>
    </div>
</div>
  </body>
</html>